name: Daily Scrape & Auto-Tag

on:
  schedule:
    - cron: '0 6 * * *'  # 6:00 AM UTC daily (11:30 AM IST)
  workflow_dispatch:  # Allow manual trigger

env:
  NTFY_TOPIC: ${{ secrets.NTFY_TOPIC }}
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}

jobs:
  scrape-and-tag:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: false
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      # ===== SCRAPING (26 countries Ã— 500 games) =====
      - name: Install Scraper Dependencies
        run: cd scraper && npm install
      
      # Batch 1: Tier 1 Revenue Markets (7 countries)
      - name: Scrape Tier 1 - Revenue Markets
        run: |
          for country in US JP KR DE GB FR TW; do
            echo "Scraping $country..."
            node scraper/google_play_fetch.js $country 500
          done
      
      # Batch 2: Tier 2 Soft Launch Markets (6 countries)
      - name: Scrape Tier 2 - Soft Launch Markets
        run: |
          for country in CA AU NZ PH SG FI; do
            echo "Scraping $country..."
            node scraper/google_play_fetch.js $country 500
          done
      
      # Batch 3: Tier 3 Dev Hubs (5 countries)
      - name: Scrape Tier 3 - Dev Hubs
        run: |
          for country in IL VN SE TR HK; do
            echo "Scraping $country..."
            node scraper/google_play_fetch.js $country 500
          done
      
      # Batch 4: Tier 4 Emerging + Additional (8 countries)
      - name: Scrape Tier 4 - Emerging Markets
        run: |
          for country in BR IN ID SA MX TH MY AE; do
            echo "Scraping $country..."
            node scraper/google_play_fetch.js $country 500
          done
      
      # ===== AUTO-TAGGING (Optional - only if GEMINI_API_KEY is set) =====
      - name: Install Tools Dependencies
        run: cd tools && npm install csv-parse csv-stringify 2>/dev/null || true
      
      - name: Run Auto-Tagger (New Games Only)
        if: env.GEMINI_API_KEY != ''
        run: node tools/auto_tag_subgenres.js 20
        continue-on-error: true
      
      # ===== INGESTION =====
      - name: Install Root Dependencies
        run: npm install pg

      - name: Ingest to Supabase
        if: env.SUPABASE_URL != ''
        run: node ingest_to_supabase.js
      
      # ===== SUBGENRE COVERAGE CHECK =====
      - name: Check Subgenre Coverage
        if: env.SUPABASE_URL != '' && env.NTFY_TOPIC != ''
        run: node tools/verify_subgenre_coverage.js
        continue-on-error: true
      
      # ===== NOTIFY =====
      - name: Send Completion Notification
        if: env.NTFY_TOPIC != ''
        run: |
          curl -s -d "ðŸŽ® Daily scrape complete! Data ingested to Supabase." \
            -H "Title: Rx Queen Update" \
            -H "Priority: default" \
            -H "Tags: video_game" \
            https://ntfy.sh/${{ secrets.NTFY_TOPIC }}
